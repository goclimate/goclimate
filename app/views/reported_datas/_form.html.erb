<%= form_with url: reported_datas_path do |form| %>
  <% field_index = 0 %>
  <% @reported_datas.each do |(category, reported_datas)| %>
    <div class="space-y-3">
      <div class="space-y-1">
        <h4 class="heading"><%= category.name %></h4>
        <p><%= category.description %></p>
      </div>
      <% reported_datas.each do |reported_data| %>
        <%= fields_for 'reported_datas[]', reported_data do |reported_data_fields| %>
          <input type="hidden" name="<%= "reported_datas[#{field_index}][calculator_field_id]" %>" value="<%= reported_data.calculator_field_id %>">
          <input type="hidden" name="<%= "reported_datas[#{field_index}][data_request_id]" %>" value="<%= reported_data.data_request_id %>">
          <input type="hidden" name="<%= "reported_datas[#{field_index}][id]" %>" value="<%= reported_data.id %>">
          <div class="flex flex-row">
            <div class="flex flex-col max-w-md w-1/2 mr-2">
              <%= label_tag reported_data.calculator_field.label, nil, class: 'font-semibold' %>
            </div>
            <div class="flex flex-col max-w-md w-1/2 mr-2">
              <% if reported_data.calculator_field.open_ended_type? %>
                <%= label_tag t('reported_datas.units'), nil, class: 'font-semibold' %>
              <% end %>
            </div>
          </div>
          <div class="flex flex-row">
            <% if reported_data.calculator_field.open_ended_type? %>
              <div class="flex flex-col max-w-md w-1/2 mr-2">
                <input type="text" name="<%= "reported_datas[#{field_index}][value]" %>" class="input" value="<%= reported_data.value %>">
              </div>
            <% else %>
              <input type="hidden" name="<%= "reported_datas[#{field_index}][value]" %>" value="1">
            <% end %>
            <div class="flex flex-col">
              <% reported_data.calculator_field.units&.each_with_index do |(key, _value), index| %>
                <% unit = BusinessCalculators::Unit.find_by(key: key) %>
                <label class="radio">
                  <input type="radio" name="<%= "reported_datas[#{field_index}][unit]" %>" value="<%= key %>" <%= key == reported_data.unit || reported_data.unit.nil? && index == 0 ? 'checked' : '' %>>
                  <span class="radio-input"></span>
                  <%= unit.name %>
                </label>
              <% end %>
              <% if reported_data.calculator_field.open_ended_type? %>
                <label class="radio">
                  <input type="radio" name="<%= "reported_datas[#{field_index}][unit]" %>" value="freeform" <%= reported_data.unit == "freeform" || reported_data.calculator_field.units.nil? ? 'checked' : '' %>>
                  <span class="radio-input"></span>
                  Other
                </label>
              <% end %>
            </div>
          </div>
        <% end %>
        <% field_index += 1 %>
      <% end %>
    </div>
  <% end %>
  <%= form.submit t('reported_datas.submit'), class: 'button button-cta mt-3', disabled: local_assigns[:disable_submit] %>
<% end %>
