<%= render "shared/header" %>

<div class="bg-blue-pastel">

  <section class="section-padding">
    <h1 class="heading-xl mb-6"><%= t 'settings' %></h1>

    <div class="text-center mb-6">
      <ul class="inline-flex overflow-hidden rounded shadow">
        <li class="px-2 py-1 bg-white hover:bg-green-shade-1 hover:text-white transition ease-in-out duration-200"><%= link_to t('account_settings'), edit_user_registration_path %></li>
        <li class="px-2 py-1 bg-primary text-white hover:bg-green-shade-1 transition ease-in-out duration-200"><%= link_to t('payment_settings'), user_subscription_path %></li>
      </ul>
    </div>
    <div class="callout max-w-xl mx-auto" data-controller="edit-card">
      <%= form_tag({ action: :update }, id: "payment-form", method: :put, class: "space-y-3") do %>

        <% if flash[:error].present? %>
          <div id="error_explanation" data-controller="scroll-here">
            <p><%= flash[:error] %></p>
          </div>
        <% end %>

        <p id="error-content"></p>

        <%= hidden_field(:setup_intent, :client_secret) %>

        <div>
          <label for="plan" class="block font-bold"><%= t 'climate_plan' %></label>
          <div class="select-wrapper w-full">
            <select id="plan" name="user[plan]" class="select">
              <% if current_page?(controller: 'subscriptions', action: 'show') %>
                <% if @current_plan_price %>
                  <option value="cancel">cancel climate plan</option>
                <% else %>
                  <option value="" selected=1>-</option>
                <% end %>
              <% end %>

              <% @available_plans.each do |i| %>
                <option value="<%= i.amount %>" <%= i == @current_plan_price ? "selected" : "" %> >
                  <%= i.to_s(precision: :auto) %>
                </option>
              <% end %>
            </select>
          </div>
        </div>

        <div>
          <label for="current-card" class="font-bold">
            <%=t 'credit_or_debit_card' %>
          </label>

          <div>
            <% if @customer_payment_method.nil? %>
              t('no_card_registered')
            <% else %>
              <div class="input flex justify-between">
                <span>
                  <span class="card-<%= card_brand(@customer_payment_method) %>"></span>
                  <%= masked_card_number(@customer_payment_method) %>
                </span>
                <span class="card-expiration"><%= card_expiration(@customer_payment_method) %></span>
              </div>
            <% end %>
            <div class="mt-1">
              <button type="button" class="button" data-action="click->edit-card#addNewCard"><%= @customer_payment_method.nil? ? t('add_new_card') : t('edit_card') %></button>
            </div>
          </div>
        </div>
        
        <div class="hidden" data-target="edit-card.newCard" data-active-class="block">
          <div id="new-card-div" data-controller="stripe-card-element">
            <label for="card-element" class="font-bold"><%=t 'add_new_card' %></label>
            <div id="card-element" class="input" data-target="stripe-card-element.container"></div>
            <div class="text-orange-shade-1" data-target="stripe-card-element.errors"></div>
          </div>

          <div id="card-errors"></div>
        </div>

        <div>
          <i class="fa fa-lock" aria-hidden="true"></i> <span class="ml-1">Secured by Stripe</span>
        </div>

        <div class="actions">
          <button id="register-button" type="submit" class="button button-cta w-full">
            <i class="fa fa-spinner fa-spin hidden" id="button-spinner"></i>
            <%= t 'update' %>
          </button>
        </div>

      <% end %>
    </div>
  </section>

  <%= render "shared/bottom_landscape" %>
</div>

<%= render "shared/footer", skip_prefooter: true %>
